<!DOCTYPE html>
<meta charset="utf-8">
<title>Gofer price model graph</title>
<style>
	body, html {
		padding: 0;
		margin: 0;
	}

	.links line {
		stroke: #999;
		stroke-opacity: 0.6;
	}

	.nodes circle {
		stroke: #fff;
		stroke-width: 1.5px;
	}

	.label {
		margin: 0;
		padding: 0;
		width: 100px;
		height: 100px;
		display: flex;
		justify-content: center;
		align-content: center;
		flex-direction: column;
		text-align: center;
		font-family: sans-serif;
		font-size: 10px;
	}

</style>
<div id="svg"></div>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script>
  let drag = simulation => {
    function dragstarted (event) {
      if (!event.active) simulation.alphaTarget(0.3).restart()
      event.subject.fx = event.subject.x
      event.subject.fy = event.subject.y
    }

    function dragged (event) {
      event.subject.fx = event.x
      event.subject.fy = event.y

    }

    function dragended (event) {
      if (!event.active) simulation.alphaTarget(0)
      event.subject.fx = null
      event.subject.fy = null
    }

    return d3.drag()
      .on('start', dragstarted)
      .on('drag', dragged)
      .on('end', dragended)
  }

  let color = function () {
    return d => d3.interpolateYlGnBu((d.level % 10) / 10)
  }

  let nodeBuilder = function (data) {
    let links = []
    let nodes = []

    let label = (node) => {
	  if (node.type === 'aggregate') {
        source = node["params"]["method"] + "<br>"
	  } else {
        source = node["origin"] + "<br>"
	  }

	  let symbol = '<b>' + node['base'] + '/' + node['quote'] + '</b><br>'
	  let price = node["price"]

      return  symbol + source + price
    }

    let uid = 1
    let recur = function (node, parent, level) {
      node.uid = uid++

      let distance = 0
      if (level === 1) {
        distance = 150
	  }

      let charge = 0
      if (node.type === 'aggregate') {
        charge = -200
      } else {
        charge = -30
      }

      nodes.push({
        id: node.uid,
        label: label(node),
		charge: charge,
        level: level,
      })

      if (parent) {
        links.push({
          source: node.uid,
          target: parent.uid,
          distance: distance,
          level: level
        })
      }

      if ('ticks' in node) {
        for (const child of node['ticks']) {
          recur(child, node, level+1)
        }
      }
    }

    for (const i in data) {
      recur(data[i], null, 0)
    }

    return [nodes, links]
  }

  d3.json('/pair?pair=COMP/USD').then(function (data) {
    let width = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0)
    let height = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)

    let [nodes, links] = nodeBuilder(data)

    const simulation = d3.forceSimulation(nodes)
      .force("charge", d3.forceManyBody()
		.strength(d => d.charge)
		.distanceMin(10)
	  )
      .force('link', d3.forceLink(links)
        .id(d => d.id)
        .distance(d => d.distance)
		.strength(1)
      )
      .force('collide', d3.forceCollide()
        .radius(40)
      )
      .force('center', d3.forceCenter(width / 2, height / 2))

    const svg = d3.select('#svg')
      .append('svg')
      .attr('width', width)
      .attr('height', height)

    var background = svg.append("g")
      .attr("class", "rect")
      .append("rect")
      .attr("width", width)
      .attr("height", height)
      .style("fill", "#fff")

    const link = svg.append('g')
      .attr('stroke', '#999')
      .attr('stroke-opacity', 0.6)
      .selectAll('line')
      .data(links)
      .join('line')
      .attr('stroke-width', d => Math.sqrt(d.value))

    const node = svg.append('g')
      .attr('stroke', '#fff')
      .attr('stroke-width', 1.5)
      .selectAll('circle')
      .data(nodes)
      .join('circle')
      .attr('r', 30)
      .attr('fill', color())

    const labels = svg.append('g')
      .selectAll('text')
      .data(nodes)
      .join('foreignObject')
	  .attr("pointer-events", "none")
	  .attr("width", 100)
      .attr("height", 100)
      .html(d => '<p class="label">' + d.label + '</p>')

    const zoom = d3.zoom()
      .scaleExtent([1/4, 64])
      .on("zoom", (event) => {
        transform = event.transform;
        node.attr("transform", event.transform);
        link.attr("transform", event.transform);
        labels.attr("transform", event.transform);
      });

    background.call(zoom)
	node.call(drag(simulation))

    simulation.on('tick', () => {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y)

      node
        .attr('cx', d => d.x)
        .attr('cy', d => d.y)

      labels
        .attr('x', d => d.x - 50)
        .attr('y', d => d.y - 50)
    })

    document.getElementById('svg').replaceWith(svg.node())
  })

</script>
